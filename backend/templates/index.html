<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>AI å±‹å­ç®¡ç†ç³»ç»Ÿ</title>
    <script src="https://cdn.socket.io/4.6.0/socket.io.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f4f4f4;
        }

        /* -------------------------------------- */
        /* å¸ƒå±€å’Œé€šç”¨æ ·å¼ */
        /* -------------------------------------- */
        .container {
            display: flex;
            gap: 20px;
            max-width: 1200px;
            margin: auto;
        }

        .left-panel {
            flex: 2;
        }

        .right-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .control-group {
            background-color: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        input[type="text"],
        input[type="number"],
        button {
            padding: 8px;
            margin-top: 5px;
            border-radius: 4px;
            border: 1px solid #ccc;
            width: 95%;
            box-sizing: border-box;
        }

        button {
            cursor: pointer;
            background-color: #4CAF50;
            color: white;
            border: none;
            transition: background-color 0.3s;
        }

        button:hover:not(:disabled) {
            background-color: #45a049;
        }

        button:disabled {
            background-color: #a0a0a0;
            cursor: not-allowed;
        }

        /* -------------------------------------- */
        /* æˆ¿é—´å¸ƒå±€å®¹å™¨æ ·å¼ */
        /* -------------------------------------- */
        #room-container {
            margin: 20px 0;
            position: relative;
            /* å°ºå¯¸å°†åœ¨ JS ä¸­æ ¹æ® roomData åŠ¨æ€è®¾ç½® */
            width: 800px;
            height: 600px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        #room {
            position: relative;
            cursor: crosshair;
            width: 100%;
            height: 100%;
            /* z-index ç¡®ä¿è§’è‰²å…ƒç´ åœ¨æ­¤ä¹‹ä¸Š */
            z-index: 1; 
        }

        /* æ–°å¢ Canvas æ ·å¼ */
        #roomCanvas {
            border: 2px solid #555;
            background-color: #fcfcfc;
            position: absolute;
            top: 0;
            left: 0;
            z-index: 0; /* ç¡®ä¿åœ¨è§’è‰²ä¹‹ä¸‹ */
        }
        
        /* è§’è‰²æ ·å¼ */
        .role {
            position: absolute;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            transition: box-shadow 0.2s, transform 0.1s;
            line-height: 1;
            text-align: center;
            z-index: 10;
            /* background-color: rgba(255, 255, 255, 0.8); */
            border: 2px solid #333;
        }

        /* ç”¨æˆ·è§’è‰²æ ·å¼ */
        .role-user {
            background-color: #ffcc00; /* çªå‡ºç”¨æˆ· */
            border-color: #cc9900;
            cursor: default; /* ç”¨æˆ·è§’è‰²ä¸å¯æ‹–æ‹½ */
        }

        /* AI è§’è‰²æ ·å¼ */
        .role-ai {
            background-color: #99ccff; /* AI è§’è‰² */
            border-color: #6699cc;
            cursor: grab; /* AI è§’è‰²å¯æ‹–æ‹½ */
        }
        
        .role-selected {
            box-shadow: 0 0 10px 5px rgba(255, 0, 0, 0.8);
            transform: scale(1.1);
            z-index: 20;
        }

        .role-activity {
            position: absolute;
            bottom: -20px;
            font-size: 12px;
            width: max-content;
            padding: 2px 5px;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            border-radius: 4px;
            white-space: nowrap;
        }

        /* -------------------------------------- */
        /* è§’è‰²ä¿¡æ¯æµ®çª—æ ·å¼ */
        /* -------------------------------------- */
        #roleInfo {
            position: absolute;
            background-color: white;
            border: 1px solid #ccc;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            z-index: 100;
            display: none;
            width: 200px;
        }

        #roleInfo p {
            margin: 5px 0;
        }

        /* -------------------------------------- */
        /* èŠå¤©æ—¥å¿—æ ·å¼ */
        /* -------------------------------------- */
        #chatLog {
            height: 300px;
            overflow-y: scroll;
            border: 1px solid #ccc;
            padding: 10px;
            background-color: white;
            border-radius: 4px;
        }

        #chatLog p {
            margin: 5px 0;
            line-height: 1.4;
        }

        .log-system {
            color: gray;
            font-weight: normal;
        }

        .log-user {
            color: #007bff;
            font-weight: bold;
        }

        .log-ai {
            color: #28a745;
            font-weight: bold;
        }

        .log-time {
            color: #999;
            font-size: 0.8em;
            margin-right: 5px;
        }
        
    </style>
</head>

<body>

    <h1>ğŸ  AI å±‹å­ç®¡ç†ç³»ç»Ÿ</h1>
    <p>
        **æ“ä½œæç¤º:** 1. åœ¨åœ°å›¾ä¸Šç‚¹å‡»è®¾ç½®æ‚¨çš„ä½ç½®ï¼ˆğŸ‘¤ï¼‰ -> 2. ç‚¹å‡» **ä¿å­˜ç”¨æˆ·ä½ç½®** -> 3. è¾“å…¥è§’è‰²ååç‚¹å‡» **æ·»åŠ è§’è‰²**ã€‚
    </p>

    <div class="container">
        <div class="left-panel">
            <div id="room-container">
                <canvas id="roomCanvas" width="800" height="600"></canvas>
                <div id="room">
                    </div>
            </div>

            <div id="roleInfo">
                <p><strong>è§’è‰²:</strong> <span id="infoRoleName"></span></p>
                <p><strong>åæ ‡:</strong> <span id="infoPosition"></span></p>
                <p><strong>æ´»åŠ¨:</strong> <span id="infoActivity"></span></p>
            </div>

            <div class="control-group">
                <h3>ğŸ—£ï¸ èŠå¤©åŒº</h3>
                <label for="chatMessage">è¾“å…¥æ¶ˆæ¯:</label>
                <input type="text" id="chatMessage" placeholder="ä¸é™„è¿‘çš„ AI è§’è‰²äº¤æµ..." autocomplete="off">
                <button id="sendChatBtn" disabled>å‘é€æ¶ˆæ¯</button>
            </div>
        </div>

        <div class="right-panel">
            <div class="control-group">
                <h3>ğŸ¤– è§’è‰²ç®¡ç†</h3>
                <label for="userNameInput">ç”¨æˆ·åç§°:</label>
                <input type="text" id="userNameInput" value="user">

                <label>ç”¨æˆ·ä½ç½® (ç‚¹å‡»åœ°å›¾è®¾ç½®):</label>
                <p id="userPosition" style="font-weight: bold;">(100, 100) é»˜è®¤</p>
                <button id="saveUserBtn" disabled>ä¿å­˜ç”¨æˆ·ä½ç½®</button>
                <hr style="margin: 10px 0;">

                <label for="newRoleName">æ–°è§’è‰²åç§°:</label>
                <input type="text" id="newRoleName" placeholder="ä¾‹å¦‚: å¦ˆå¦ˆ/AIå°æ">
                <button id="addRoleBtn">æ·»åŠ è§’è‰²</button>
                <button id="clearRoomBtn" style="background-color: #dc3545; margin-top: 10px;">æ¸…ç©ºAIè§’è‰²</button>
            </div>

            <div class="control-group">
                <h3>â±ï¸ æ—¶é—´æ§åˆ¶</h3>
                <label for="currentTime">å½“å‰è™šæ‹Ÿæ—¶é—´:</label>
                <p id="currentTime" style="font-weight: bold;">--/--</p>
                
                <label for="timeAcceleration">åŠ é€Ÿå€ç‡ (1-1000x):</label>
                <input type="number" id="timeAcceleration" value="60" min="1" max="1000">
                <button id="startTimeBtn">å¯åŠ¨æ—¶é—´åŠ é€Ÿ</button>
                <button id="stopTimeBtn" disabled style="background-color: #ffc107;">åœæ­¢æ—¶é—´</button>
            </div>

            <div class="control-group">
                <h3>ğŸ“œ å®æ—¶æ—¥å¿—</h3>
                <div id="chatLog">
                    </div>
            </div>
        </div>
    </div>

    <script>
        // ----------------------------------------------------
        // I. å…¨å±€å˜é‡ä¸åˆå§‹åŒ–
        // ----------------------------------------------------
        const socket = io({ path: '/socket.io/' });
        const roomElement = document.getElementById("room");
        const chatLog = document.getElementById("chatLog");
        const roleSize = 60; // è§’è‰²å›¾æ ‡çš„ç›´å¾„
        
        let userName = document.getElementById("userNameInput").value;
        let userPosition = { x: 100, y: 100 };
        let roomData = null; // å­˜å‚¨æœåŠ¡å™¨ä¼ æ¥çš„å®Œæ•´æˆ¿é—´æ•°æ®
        let roomDimensions = { width: 800, height: 600 }; // æˆ¿é—´å°ºå¯¸
        
        // æ‹–æ‹½ç›¸å…³å˜é‡ (æ–°å¢ for AI roles)
        let isDragging = false;
        let draggedRole = null;
        let offsetX = 0;
        let offsetY = 0;
        
        // Canvas å˜é‡
        const canvas = document.getElementById('roomCanvas');
        const ctx = canvas.getContext('2d');
        const collisionRadius = 20; // ç”¨äºç¢°æ’æ£€æµ‹çš„åœ†å½¢åŠå¾„ (ç¨å¾®å°äºè§’è‰²å°ºå¯¸/2)

        // ----------------------------------------------------
        // II. Socket.IO äº‹ä»¶ç›‘å¬
        // ----------------------------------------------------

        socket.on('connect', function () {
            logMessage("System", `å·²è¿æ¥åˆ°æœåŠ¡å™¨. Socket ID: ${socket.id}`, getTime(), "log-system");
            // é¦–æ¬¡è¿æ¥æ—¶è¯·æ±‚æˆ¿é—´æ•°æ®å’Œè§’è‰²åˆ—è¡¨
            socket.emit('request_initial_data', { room_name: 'main' }); 
        });

        socket.on('disconnect', function () {
            logMessage("System", "ä¸æœåŠ¡å™¨æ–­å¼€è¿æ¥.", getTime(), "log-system");
        });

        socket.on('room_data_update', function (data) {
            roomData = data;
            console.log("æ”¶åˆ°æˆ¿é—´æ•°æ®æ›´æ–°:", roomData);
            
            // 1. æ›´æ–°æˆ¿é—´å°ºå¯¸
            roomDimensions.width = roomData.width || 800;
            roomDimensions.height = roomData.height || 600;
            canvas.width = roomDimensions.width;
            canvas.height = roomDimensions.height;
            roomElement.style.width = roomDimensions.width + 'px';
            roomElement.style.height = roomDimensions.height + 'px';
            document.getElementById("room-container").style.width = roomDimensions.width + 'px';
            document.getElementById("room-container").style.height = roomDimensions.height + 'px';

            // 2. æ¸²æŸ“æˆ¿é—´å¸ƒå±€ (Canvas)
            renderLayout(roomData.layout);

            // 3. æ¸²æŸ“è§’è‰² (HTML Elements)
            renderRoles(roomData.roles);
        });
        
        socket.on('chat_message', function (data) {
            const cssClass = data.sender === userName ? "log-user" : "log-ai";
            logMessage(data.sender, data.message, data.time, cssClass);
        });

        socket.on('time_update', function (data) {
            document.getElementById("currentTime").innerText = data.formatted_time;
        });
        
        // ----------------------------------------------------
        // III. æ¸²æŸ“å‡½æ•°
        // ----------------------------------------------------

        function renderLayout(layout) {
            // æ¸…é™¤ Canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // æ¸²æŸ“åŒºåŸŸ (Areas)
            if (layout && layout.areas) {
                layout.areas.forEach(area => {
                    ctx.fillStyle = area.color;
                    ctx.fillRect(area.x, area.y, area.width, area.height);
                    ctx.strokeStyle = '#ccc';
                    ctx.strokeRect(area.x, area.y, area.width, area.height);
                });
            }

            // æ¸²æŸ“å¢™å£ (Walls)
            if (layout && layout.walls) {
                layout.walls.forEach(wall => {
                    ctx.beginPath();
                    ctx.lineWidth = wall.thickness;
                    ctx.strokeStyle = wall.isOuter ? '#333' : '#555';
                    ctx.moveTo(wall.x1, wall.y1);
                    ctx.lineTo(wall.x2, wall.y2);
                    ctx.stroke();
                });
            }

            // æ¸²æŸ“é—¨çª— (Doors/Windows)
            if (layout && layout.doors) {
                layout.doors.forEach(door => {
                    // é—¨çš„ä¸­å¿ƒç‚¹
                    const centerX = door.direction === 'horizontal' ? door.x + door.width / 2 : door.x;
                    const centerY = door.direction === 'vertical' ? door.y + door.width / 2 : door.y;

                    // ç»˜åˆ¶é—¨æ´
                    ctx.beginPath();
                    ctx.lineWidth = door.thickness + 2; // ç¨å¾®å®½ä¸€ç‚¹
                    ctx.strokeStyle = '#fcfcfc'; // ç”¨èƒŒæ™¯è‰²è¦†ç›–å¢™å£
                    if (door.direction === 'horizontal') {
                        ctx.moveTo(door.x, door.y);
                        ctx.lineTo(door.x + door.width, door.y);
                    } else {
                        ctx.moveTo(door.x, door.y);
                        ctx.lineTo(door.x, door.y + door.width);
                    }
                    ctx.stroke();

                    // ç»˜åˆ¶é—¨æ‰‡
                    ctx.beginPath();
                    ctx.lineWidth = 4;
                    ctx.strokeStyle = '#666';
                    ctx.fillStyle = '#f8f8f8';
                    if (door.direction === 'horizontal') {
                        // ç»˜åˆ¶ä¸€ä¸ªå¼§çº¿è¡¨ç¤ºé—¨çš„æ‰“å¼€æ–¹å‘
                        ctx.arc(door.x, door.y, door.width, Math.PI * 1.5, Math.PI * 0.5);
                    } else {
                        ctx.arc(door.x, door.y, door.width, Math.PI, Math.PI * 2);
                    }
                    ctx.stroke();
                });
            }
            
            // æ¸²æŸ“å®¶å…· (Furniture) - ä»…ç»˜åˆ¶çŸ©å½¢
            if (layout && layout.furniture) {
                layout.furniture.forEach(item => {
                    ctx.fillStyle = item.color;
                    ctx.fillRect(item.x, item.y, item.width, item.height);
                    ctx.strokeStyle = '#333';
                    ctx.strokeRect(item.x, item.y, item.width, item.height);
                    
                    // æ ‡æ³¨å®¶å…·åç§° (å¯é€‰)
                    ctx.fillStyle = '#333';
                    ctx.font = '10px Arial';
                    ctx.textAlign = 'center';
                    ctx.fillText(item.name, item.x + item.width / 2, item.y + item.height / 2 + 3);
                });
            }
        }

        function renderRoles(roles) {
            // æ¸…é™¤æ‰€æœ‰ç°æœ‰è§’è‰²
            roomElement.querySelectorAll('.role').forEach(r => r.remove());

            roles.forEach(role => {
                const isUser = role.name === userName;
                
                // æ‰¾åˆ°ç”¨æˆ·è§’è‰²å¹¶æ›´æ–°å…¶ä½ç½®ï¼Œä»¥ä¾¿äºå‘é€èŠå¤©
                if (isUser) {
                    userPosition.x = role.x;
                    userPosition.y = role.y;
                }

                const roleElement = document.createElement('div');
                roleElement.className = isUser ? 'role role-user' : 'role role-ai';
                roleElement.dataset.roleName = role.name; // ç”¨äºæ‹–æ‹½å’Œä¿¡æ¯æ˜¾ç¤º

                // è®¡ç®—è§’è‰²å·¦ä¸Šè§’ä½ç½® (x, y æ˜¯ä¸­å¿ƒç‚¹)
                const left = role.x - roleSize / 2;
                const top = role.y - roleSize / 2;

                roleElement.style.left = left + 'px';
                roleElement.style.top = top + 'px';
                roleElement.title = role.name;
                roleElement.innerHTML = `
                    ${role.avatar}
                    <span class="role-activity" style="transform: translateX(-50%); left: 50%;">
                        ${role.activity || 'ä¼‘æ¯ä¸­'}
                    </span>
                `;

                // ------------------------------------------
                // æ‹–æ‹½é€»è¾‘: ä»…ä¸º AI è§’è‰²æ·»åŠ æ‹–æ‹½ç›‘å¬
                // ------------------------------------------
                if (!isUser) {
                    roleElement.style.cursor = 'grab';
                    roleElement.addEventListener('mousedown', startDrag);
                    roleElement.addEventListener('touchstart', startDrag); 
                }
                
                // ç‚¹å‡»è§’è‰²æ˜¾ç¤ºä¿¡æ¯
                roleElement.addEventListener('click', (e) => showRoleInfo(e, role));


                roomElement.appendChild(roleElement);
            });
        }
        
        // ----------------------------------------------------
        // IV. ç¢°æ’æ£€æµ‹é€»è¾‘ (Collision Detection)
        // ----------------------------------------------------

        function checkCollision(centerX, centerY) {
            if (!roomData || !roomData.layout) return false;

            const layout = roomData.layout;
            const r = collisionRadius; // ç¢°æ’æ£€æµ‹åŠå¾„

            // 1. æ£€æŸ¥æ˜¯å¦ç¢°æ’å¢™å£/å®¶å…· (ç®€åŒ–ç‰ˆï¼šä»…æ£€æŸ¥ä¸­å¿ƒç‚¹æ˜¯å¦åœ¨ç‰©ä½“å†…éƒ¨)
            const objects = (layout.walls || []).concat(layout.furniture || []);
            
            for (const obj of objects) {
                // å¯¹äºå¢™å£ (ç®€åŒ–å¤„ç†ï¼šåªæ£€æŸ¥çº¿æ®µé™„è¿‘çš„ç‚¹)
                if (obj.x1 !== undefined && obj.x2 !== undefined) {
                    // ä»…æ£€æŸ¥ä¸­å¿ƒç‚¹ä¸çº¿æ®µçš„è·ç¦»æ˜¯å¦å°äºç¢°æ’åŠå¾„ (å¤æ‚ï¼Œå…ˆè·³è¿‡)
                    // ç®€åŒ–ï¼šå¦‚æœç‚¹éå¸¸æ¥è¿‘å¢™å£ï¼Œåˆ™è®¤ä¸ºç¢°æ’ï¼ˆä¸ç²¾ç¡®ï¼Œä½†æ¯”æ²¡æœ‰å¥½ï¼‰
                    // å¯¹äºå‚ç›´å¢™: x1 == x2. æ£€æŸ¥ centerX æ˜¯å¦åœ¨ x1 é™„è¿‘
                    if (obj.x1 === obj.x2 && Math.abs(centerX - obj.x1) < r) {
                        if (centerY >= Math.min(obj.y1, obj.y2) && centerY <= Math.max(obj.y1, obj.y2)) {
                             return true;
                        }
                    }
                    // å¯¹äºæ°´å¹³å¢™: y1 == y2. æ£€æŸ¥ centerY æ˜¯å¦åœ¨ y1 é™„è¿‘
                    if (obj.y1 === obj.y2 && Math.abs(centerY - obj.y1) < r) {
                        if (centerX >= Math.min(obj.x1, obj.x2) && centerX <= Math.max(obj.x1, obj.x2)) {
                            return true;
                        }
                    }

                } 
                // å¯¹äºå®¶å…· (Area, Box)
                else if (obj.x !== undefined && obj.width !== undefined) {
                    // æ£€æŸ¥ä¸­å¿ƒç‚¹æ˜¯å¦åœ¨å®¶å…·/åŒºåŸŸå†…éƒ¨ (Area/Furniture)
                    if (centerX >= obj.x && centerX <= obj.x + obj.width &&
                        centerY >= obj.y && centerY <= obj.y + obj.height) {
                        return true;
                    }
                }
            }

            // 2. æ£€æŸ¥æ˜¯å¦ç¢°æ’å…¶ä»–è§’è‰² (ä¹Ÿä»…æ£€æŸ¥ä¸­å¿ƒç‚¹è·ç¦»)
            // æ¯æ¬¡æ‹–æ‹½åªæ£€æŸ¥ä¸å…¶ä»–è§’è‰²çš„ç¢°æ’
            const currentRoles = Array.from(roomElement.querySelectorAll('.role'));
            for (const roleEl of currentRoles) {
                const roleName = roleEl.dataset.roleName;
                // è·³è¿‡æ­£åœ¨æ‹–æ‹½çš„è§’è‰²
                if (draggedRole && roleName === draggedRole.dataset.roleName) continue; 
                
                const role = roomData.roles.find(r => r.name === roleName);
                if (!role) continue;
                
                const distanceX = centerX - role.x;
                const distanceY = centerY - role.y;
                const distance = Math.sqrt(distanceX * distanceX + distanceY * distanceY);
                
                // å¦‚æœä¸¤ä¸ªè§’è‰²ä¸­å¿ƒç‚¹è·ç¦»å°äºè§’è‰²å°ºå¯¸ (60px) åˆ™è®¤ä¸ºç¢°æ’
                if (distance < roleSize) {
                    return true;
                }
            }


            return false;
        }


        // ----------------------------------------------------
        // V. AI è§’è‰²æ‹–æ‹½é€»è¾‘ (æ–°å¢)
        // ----------------------------------------------------

        function startDrag(e) {
            // é˜»æ­¢ç‚¹å‡»äº‹ä»¶å‘ä¸Šå†’æ³¡åˆ° room çš„ click äº‹ä»¶
            e.stopPropagation(); 
            
            // é˜»æ­¢æµè§ˆå™¨é»˜è®¤æ‹–æ‹½è¡Œä¸º
            if (e.type === 'mousedown') e.preventDefault(); 
            
            isDragging = true;
            draggedRole = this; // 'this' æŒ‡å‘ roleElement
            
            const rect = draggedRole.getBoundingClientRect();
            const clientX = e.type.startsWith('touch') ? e.touches[0].clientX : e.clientX;
            const clientY = e.type.startsWith('touch') ? e.touches[0].clientY : e.clientY;
            
            offsetX = clientX - rect.left;
            offsetY = clientY - rect.top;
            
            draggedRole.style.cursor = 'grabbing';
            draggedRole.classList.add('role-selected');
            
            // æ³¨å†Œå…¨å±€äº‹ä»¶
            document.addEventListener('mousemove', drag);
            document.addEventListener('mouseup', endDrag);
            document.addEventListener('touchmove', drag);
            document.addEventListener('touchend', endDrag);
            
            // éšè—ä¿¡æ¯æµ®çª—é˜²æ­¢å¹²æ‰°
            document.getElementById("roleInfo").style.display = "none";
        }

        function drag(e) {
            if (!isDragging) return;
            
            const clientX = e.type.startsWith('touch') ? e.touches[0].clientX : e.clientX;
            const clientY = e.type.startsWith('touch') ? e.touches[0].clientY : e.clientY;

            const roomRect = document.getElementById("room").getBoundingClientRect();
            
            let newX = clientX - roomRect.left - offsetX;
            let newY = clientY - roomRect.top - offsetY;

            // è®¡ç®—ä¸­å¿ƒç‚¹åæ ‡
            const centerX = newX + roleSize / 2;
            const centerY = newY + roleSize / 2;
            
            // è¾¹ç•Œæ£€æŸ¥ (ç¡®ä¿ä¸­å¿ƒç‚¹åœ¨æˆ¿é—´å†…)
            const boundedX = Math.max(roleSize / 2, Math.min(centerX, roomDimensions.width - roleSize / 2));
            const boundedY = Math.max(roleSize / 2, Math.min(centerY, roomDimensions.height - roleSize / 2));
            
            // ç¢°æ’æ£€æŸ¥ (ä½¿ç”¨ center X/Y)
            if (checkCollision(boundedX, boundedY)) {
                // å¦‚æœç¢°æ’ï¼Œä¸ç§»åŠ¨ï¼Œä¿æŒåœ¨åŸåœ°
                return; 
            }

            // è½¬æ¢å›å·¦ä¸Šè§’åæ ‡
            const finalX = boundedX - roleSize / 2;
            const finalY = boundedY - roleSize / 2;

            draggedRole.style.left = finalX + 'px';
            draggedRole.style.top = finalY + 'px';
        }

        function endDrag(e) {
            if (!isDragging) return;
            
            isDragging = false;
            draggedRole.style.cursor = 'grab';
            draggedRole.classList.remove('role-selected');

            document.removeEventListener('mousemove', drag);
            document.removeEventListener('mouseup', endDrag);
            document.removeEventListener('touchmove', drag);
            document.removeEventListener('touchend', endDrag);
            
            // è·å¾—æœ€ç»ˆä½ç½® (å·¦ä¸Šè§’)
            const finalLeft = parseFloat(draggedRole.style.left);
            const finalTop = parseFloat(draggedRole.style.top);

            // è½¬æ¢ä¸ºä¸­å¿ƒç‚¹åæ ‡
            const finalCenterX = Math.round(finalLeft + roleSize / 2);
            const finalCenterY = Math.round(finalTop + roleSize / 2);
            
            const roleName = draggedRole.dataset.roleName;

            // 3. å‘é€ Socket.IO äº‹ä»¶åˆ°æœåŠ¡å™¨
            socket.emit('update_role_position', {
                room_name: 'main',
                role_name: roleName,
                x: finalCenterX,
                y: finalCenterY
            });
            
            logMessage("System", `è§’è‰² ${roleName} ç§»åŠ¨åˆ° (${finalCenterX}, ${finalCenterY}).`, getTime(), "log-system");
            
            // æ¸…ç†
            draggedRole = null;
        }

        // ----------------------------------------------------
        // VI. ç”¨æˆ·äº¤äº’äº‹ä»¶ç›‘å¬
        // ----------------------------------------------------

        // 1. ç”¨æˆ·åè¾“å…¥
        document.getElementById("userNameInput").addEventListener("change", function () {
            userName = this.value;
            // é‡æ–°å‘é€ç”¨æˆ·ä½ç½®ä»¥æ›´æ–°æœåŠ¡å™¨ä¸Šçš„è§’è‰²å
            if (userPosition.x) {
                addUserToRoom();
            }
        });

        // 2. ä¿å­˜ç”¨æˆ·ä½ç½®
        document.getElementById("saveUserBtn").addEventListener("click", function () {
            addUserToRoom();
            updateUserButtons(false); // ä¿å­˜åç¦ç”¨æŒ‰é’®ç›´åˆ°ä½ç½®å†æ¬¡æ”¹å˜
        });
        
        function addUserToRoom() {
            // å§‹ç»ˆä½¿ç”¨ç”¨æˆ·åç§°è¾“å…¥æ¡†ä¸­çš„å€¼
            const name = document.getElementById("userNameInput").value; 
            
            socket.emit('update_user_position', {
                room_name: 'main',
                role_name: name,
                x: userPosition.x,
                y: userPosition.y,
                avatar: 'ğŸ‘¤'
            });
            logMessage("System", `ç”¨æˆ· ${name} ä½ç½®å·²ä¿å­˜åˆ° (${userPosition.x}, ${userPosition.y}).`, getTime(), "log-system");
        }

        // 3. æ·»åŠ æ–°è§’è‰² (æ›´æ–°: ä½¿ç”¨ç”¨æˆ·ä½ç½®ä½œä¸ºé»˜è®¤ä½ç½®)
        document.getElementById("addRoleBtn").addEventListener("click", function () {
            const roleName = document.getElementById("newRoleName").value;
            if (roleName) {
                // ä½¿ç”¨ç”¨æˆ·è®¾ç½®çš„ä½ç½®ä½œä¸º AI çš„èµ·å§‹ä½ç½®
                const startX = 100;
                const startY = 100;

                if (checkCollision(startX, startY)) {
                    alert(`æ— æ³•åœ¨ (${startX}, ${startY}) æ·»åŠ è§’è‰²ï¼Œè¯·é€‰æ‹©ç©ºé—²ä½ç½®ã€‚`);
                    return;
                }

                socket.emit('add_role', {
                    room_name: 'main',
                    role_name: roleName,
                    x: startX, // <-- ä½¿ç”¨ç”¨æˆ·è®¾ç½®çš„ä½ç½®
                    y: startY, // <-- ä½¿ç”¨ç”¨æˆ·è®¾ç½®çš„ä½ç½®
                    avatar: 'ğŸ¤–'
                });
                logMessage("System", `æ­£åœ¨æ·»åŠ è§’è‰² ${roleName} åˆ° (${startX}, ${startY})...`, getTime(), "log-system");
            } else {
                alert("è¯·è¾“å…¥æ–°è§’è‰²çš„åç§°ã€‚");
            }
        });

        // 4. æ¸…ç©ºæˆ¿é—´
        document.getElementById("clearRoomBtn").addEventListener("click", function () {
            if (confirm("ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰ AI è§’è‰²å—ï¼Ÿï¼ˆç”¨æˆ·è§’è‰²ä¼šè¢«ä¿ç•™ï¼‰")) {
                socket.emit('clear_room', { room_name: 'main' });
                logMessage("System", "æ‰€æœ‰ AI è§’è‰²å·²æ¸…é™¤ã€‚", getTime(), "log-system");
            }
        });

        // 5. èŠå¤©å‘é€
        document.getElementById("sendChatBtn").addEventListener("click", function () {
            sendMessage();
        });

        function sendMessage() {
            const chatInput = document.getElementById("chatMessage");
            const message = chatInput.value.trim();
            if (message && userPosition.x && userPosition.y) {
                // å‘é€ HTTP è¯·æ±‚åˆ° FastAPI è·¯ç”±
                fetch(`/distance_chat/main`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        sender: userName,
                        message: message,
                        x: userPosition.x,
                        y: userPosition.y
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status !== 'success') {
                        logMessage("System", `å‘é€æ¶ˆæ¯å¤±è´¥: ${data.detail}`, getTime(), "log-system");
                    }
                    // å®é™…çš„æ¶ˆæ¯å¹¿æ’­ç”±æœåŠ¡å™¨ç«¯çš„ socket.emit('chat_message') å¤„ç†
                })
                .catch(error => {
                    console.error('Error sending chat:', error);
                    logMessage("System", "å‘é€æ¶ˆæ¯æ—¶å‘ç”Ÿç½‘ç»œé”™è¯¯ã€‚", getTime(), "log-system");
                });
                
                chatInput.value = ''; // æ¸…ç©ºè¾“å…¥æ¡†
            } else if (!userPosition.x) {
                alert("è¯·å…ˆè®¾ç½®æ‚¨çš„ä½ç½®ã€‚");
            }
        }
        
        // 6. æˆ¿é—´ç‚¹å‡»è®¾ç½®ç”¨æˆ·ä½ç½®
        document.getElementById("room").addEventListener("click", function (e) {
            // é¿å…ç‚¹å‡»åˆ°è§’è‰²æ—¶è§¦å‘
            if (e.target.closest('.role')) {
                return;
            }

            const roomRect = this.getBoundingClientRect();
            const x = e.clientX - roomRect.left;
            const y = e.clientY - roomRect.top;

            // è®¡ç®—ä¸­å¿ƒç‚¹åæ ‡
            const centerX = x;
            const centerY = y;

            // è¾¹ç•Œæ£€æŸ¥ (ä½¿ç”¨ä¸­å¿ƒç‚¹åæ ‡)
            const boundedX = Math.max(roleSize / 2, Math.min(centerX, roomDimensions.width - roleSize / 2));
            const boundedY = Math.max(roleSize / 2, Math.min(centerY, roomDimensions.height - roleSize / 2));
            
            // ç¢°æ’æ£€æµ‹
            if (checkCollision(boundedX, boundedY)) {
                console.log("ç‚¹å‡»ä½ç½®æœ‰ç¢°æ’ï¼Œæ— æ³•è®¾ç½®ç”¨æˆ·ä½ç½®ã€‚");
                alert("æ— æ³•å°†äººç‰©æ”¾ç½®åœ¨å¢™å£æˆ–å®¶å…·å†…éƒ¨ï¼");
                return; 
            }

            userPosition = { x: Math.round(boundedX), y: Math.round(boundedY) };
            document.getElementById("userPosition").innerText =
                `(${userPosition.x}, ${userPosition.y}) å·²è®¾ç½®`;

            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            updateUserButtons(true);

            // å®æ—¶æ˜¾ç¤ºç”¨æˆ·å›¾æ ‡
            addUserToRoom();
        });

        // 7. ç‚¹å‡»å…¶ä»–åœ°æ–¹éšè—è§’è‰²ä¿¡æ¯
        document.addEventListener("click", (e) => {
            if (!e.target.closest("#roleInfo") && !e.target.closest(".role")) {
                document.getElementById("roleInfo").style.display = "none";
            }
        });

        // 8. å›è½¦å‘é€æ¶ˆæ¯
        document.getElementById("chatMessage").addEventListener("keypress", function (e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                document.getElementById("sendChatBtn").click();
            }
        });

        // 9. å¯åŠ¨/åœæ­¢æ—¶é—´
        document.getElementById("startTimeBtn").addEventListener("click", function () {
            const acceleration = parseInt(document.getElementById("timeAcceleration").value);
            socket.emit('start_time', { acceleration: acceleration });
            document.getElementById("startTimeBtn").disabled = true;
            document.getElementById("stopTimeBtn").disabled = false;
        });

        // åœæ­¢æ—¶é—´
        document.getElementById("stopTimeBtn").addEventListener("click", function () {
            socket.emit('stop_time');
            document.getElementById("startTimeBtn").disabled = false;
            document.getElementById("stopTimeBtn").disabled = true;
        });

        // ----------------------------------------------------
        // VII. å·¥å…·å‡½æ•°
        // ----------------------------------------------------

        function getTime() {
             return document.getElementById("currentTime").innerText.split(' ')[1] || '00:00:00';
        }

        function logMessage(sender, message, time, cssClass) {
            const timeSpan = `<span class="log-time">(${time})</span>`;
            const senderSpan = `<span class="${cssClass}">${sender}</span>: `
            const messageHtml = `<p>${timeSpan} ${senderSpan} ${message}</p>`;
            
            chatLog.innerHTML += messageHtml;
            chatLog.scrollTop = chatLog.scrollHeight; // æ»šåŠ¨åˆ°åº•éƒ¨
        }
        
        function updateUserButtons(enabled) {
            document.getElementById("saveUserBtn").disabled = !enabled;
            document.getElementById("sendChatBtn").disabled = !enabled;
        }

        function showRoleInfo(e, role) {
            e.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡åˆ° room çš„ click äº‹ä»¶

            const infoBox = document.getElementById("roleInfo");
            const roomRect = document.getElementById("room").getBoundingClientRect();
            
            // è®¡ç®—ç›¸å¯¹äºæˆ¿é—´å®¹å™¨çš„ä½ç½®
            const x = role.x; 
            const y = role.y; 
            
            // è®¾ç½®æµ®çª—å†…å®¹
            document.getElementById("infoRoleName").innerText = role.name;
            document.getElementById("infoPosition").innerText = `(${role.x}, ${role.y})`;
            document.getElementById("infoActivity").innerText = role.activity || 'ä¼‘æ¯ä¸­';
            
            // è®¾ç½®æµ®çª—ä½ç½® (åœ¨è§’è‰²å³ä¸‹æ–¹)
            infoBox.style.left = (x + roleSize / 2 + 10) + 'px';
            infoBox.style.top = (y - infoBox.offsetHeight / 2) + 'px'; // å‚ç›´å±…ä¸­äºè§’è‰²
            infoBox.style.display = "block";
        }
        
    </script>
</body>

</html>