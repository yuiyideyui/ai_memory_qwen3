<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>å®¶å…·ç¬¦å·ä¼˜åŒ–ç‰ˆä½å®…å¹³é¢å›¾</title>
    <style>
        #roomCanvas {
            border: 2px solid #555;
            background-color: #fcfcfc;
        }
        .container {
            font-family: Arial, sans-serif;
            padding: 20px;
        }
        h1 {
            color: #2F4F4F;
        }
        p {
            margin-top: 10px;
        }
    </style>
</head>
<body>

    <div class="container">
        <h1>ğŸ›‹ï¸ ç¢°æ’ä¿®å¤ç‰ˆå•å±‚ä½å®…å¹³é¢å›¾</h1>
        <p>å§å®¤é—¨ç¢°æ’é€»è¾‘å·²ä¼˜åŒ–ã€‚è¯·ä½¿ç”¨ **W A S D** é”®æµ‹è¯•äººç‰© (ğŸ‘¤) ç©¿è¿‡æ‰€æœ‰é—¨ã€‚</p>
        <canvas id="roomCanvas" width="800" height="600"></canvas>
    </div>

    <script>
        // 1. å®Œæ•´çš„ JSON æˆ¿å±‹æ•°æ®
        const roomData = {
          "name": "å•å±‚ä½å®…å¹³é¢å›¾",
          "width": 800,
          "height": 600,
          "scale": 10,
          "roles": [
            {
              "name": "user",
              "type": "person",
              "x": 100,
              "y": 100,
              "size": 20,
              "avatar": "ğŸ‘¤"
            }
          ],
          "layout": {
            "areas": [
              { "id": "A1", "name": "å®¢å…", "x": 50, "y": 50, "width": 450, "height": 300, "color": "#F0FFF0" },
              { "id": "A2", "name": "å§å®¤", "x": 50, "y": 350, "width": 450, "height": 200, "color": "#F5FFFA" },
              { "id": "A3", "name": "å¨æˆ¿", "x": 500, "y": 50, "width": 250, "height": 200, "color": "#FFF5EE" },
              { "id": "A4", "name": "å«ç”Ÿé—´", "x": 500, "y": 250, "width": 250, "height": 300, "color": "#F0FFFF" }
            ],
            "walls": [
              // å¤–éƒ¨å¢™å£
              { "id": 1, "x1": 50, "y1": 50, "x2": 750, "y2": 50, "thickness": 10, "isOuter": true },
              { "id": 2, "x1": 750, "y1": 50, "x2": 750, "y2": 550, "thickness": 10, "isOuter": true },
              { "id": 3, "x1": 750, "y1": 550, "x2": 50, "y2": 550, "thickness": 10, "isOuter": true },
              { "id": 4, "x1": 50, "y1": 550, "x2": 50, "y2": 50, "thickness": 10, "isOuter": true },
              // å†…éƒ¨å¢™å£
              { "id": 5, "x1": 50, "y1": 350, "x2": 500, "y2": 350, "thickness": 5 }, // å®¢å…/å§å®¤ä¹‹é—´çš„å¢™
              { "id": 6, "x1": 500, "y1": 50, "x2": 500, "y2": 550, "thickness": 5 }, // ä¸­å¤®åˆ†éš”å¢™
              { "id": 7, "x1": 500, "y1": 250, "x2": 750, "y2": 250, "thickness": 5 } // å¨æˆ¿/å«ç”Ÿé—´ä¹‹é—´çš„å¢™
            ],
            "doors": [
              { "id": 101, "name": "å…¥æˆ·é—¨", "x": 50, "y": 150, "width": 60, "thickness": 10, "direction": "vertical", "area": "A1" },
              { "id": 102, "name": "å§å®¤é—¨", "x": 285, "y": 350, "width": 60, "thickness": 5, "direction": "horizontal", "area": "A2" }, 
              { "id": 103, "name": "å¨æˆ¿é—¨", "x": 500, "y": 150, "width": 60, "thickness": 5, "direction": "vertical", "area": "A3" },
              { "id": 104, "name": "å«ç”Ÿé—´é—¨", "x": 500, "y": 400, "width": 60, "thickness": 5, "direction": "vertical", "area": "A4" }
            ],
            "windows": [
              { "id": 201, "x": 150, "y": 50, "width": 150, "thickness": 10, "direction": "horizontal" },
              { "id": 202, "x": 150, "y": 550, "width": 150, "thickness": 10, "direction": "horizontal" }
            ],
            "furniture": [
              { "id": 301, "name": "æ²™å‘", "type": "sofa", "x": 100, "y": 280, "width": 200, "height": 50, "color": "#A9A9A9" },
              { "id": 302, "name": "èŒ¶å‡ ", "type": "table", "x": 160, "y": 250, "width": 80, "height": 40, "color": "#CD853F" }, 
              { "id": 303, "name": "ç”µè§†æŸœ", "type": "cabinet", "x": 350, "y": 60, "width": 150, "height": 30, "color": "#A0522D" },
              { "id": 401, "name": "åŒäººåºŠ", "type": "bed", "x": 150, "y": 400, "width": 180, "height": 120, "color": "#708090" },
              { "id": 402, "name": "è¡£æŸœ", "type": "closet", "x": 55, "y": 400, "width": 50, "height": 100, "color": "#A0522D" },
              { "id": 501, "name": "Lå‹æ©±æŸœ", "type": "counter", "x": 520, "y": 60, "width": 210, "height": 40, "color": "#8FBC8F" }, 
              { "id": 502, "name": "Lå‹æ©±æŸœ", "type": "counter", "x": 710, "y": 100, "width": 40, "height": 140, "color": "#8FBC8F" }, 
              { "id": 503, "name": "å†°ç®±", "type": "fridge", "x": 505, "y": 60, "width": 30, "height": 40, "color": "#C0C0C0" },
              { "id": 601, "name": "é©¬æ¡¶", "type": "toilet", "x": 550, "y": 300, "width": 40, "height": 40, "color": "#FFFFFF" },
              { "id": 602, "name": "æ´—è„¸å°", "type": "sink", "x": 650, "y": 300, "width": 80, "height": 40, "color": "#FFFFFF" },
              { "id": 603, "name": "æ·‹æµ´åŒº", "type": "shower", "x": 550, "y": 450, "width": 100, "height": 80, "color": "#ADD8E6" }
            ]
          }
        };

        const canvas = document.getElementById('roomCanvas');
        const ctx = canvas.getContext('2d');
        const person = roomData.roles[0];
        const MOVE_SPEED = 3; 
        
        // è¾…åŠ©å‡½æ•°ï¼šç»˜åˆ¶å®¶å…·åç§° (ä¿æŒä¸å˜)
        function drawLabel(item) {
            ctx.fillStyle = '#111';
            ctx.font = '10px Arial';
            ctx.textAlign = 'left';
            ctx.fillText(item.name, item.x + 3, item.y + 10);
        }

        // 2. å¢å¼ºçš„ç»˜åˆ¶å‡½æ•° (ä¿æŒä¸å˜)
        function drawRoom() {
            ctx.clearRect(0, 0, roomData.width, roomData.height);

            // ç»˜åˆ¶åŒºåŸŸå’Œåç§°
            roomData.layout.areas.forEach(area => {
                ctx.fillStyle = area.color;
                ctx.fillRect(area.x, area.y, area.width, area.height);
                ctx.fillStyle = '#333';
                ctx.font = '16px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(area.name, area.x + area.width / 2, area.y + 20);
            });

            // ç»˜åˆ¶å¢™å£
            roomData.layout.walls.forEach(wall => {
                ctx.beginPath();
                ctx.strokeStyle = wall.isOuter ? '#000000' : '#8B4513'; 
                ctx.lineWidth = wall.thickness;
                ctx.lineCap = 'butt';
                ctx.moveTo(wall.x1, wall.y1);
                ctx.lineTo(wall.x2, wall.y2);
                ctx.stroke();
            });

            // ç»˜åˆ¶é—¨ (ç”¨ç™½è‰²çŸ©å½¢è¡¨ç¤ºå¼€å£)
            roomData.layout.doors.forEach(door => {
                ctx.fillStyle = '#FFFFFF'; 
                ctx.strokeStyle = '#8B4513';
                ctx.lineWidth = 1;

                if (door.direction === 'vertical') {
                    const x = door.x;
                    ctx.fillRect(x - door.thickness / 2, door.y, door.thickness, door.width);
                } else {
                    const y = door.y;
                    ctx.fillRect(door.x, y - door.thickness / 2, door.width, door.thickness);
                }
            });
            
            // ç»˜åˆ¶çª—æˆ·
            roomData.layout.windows.forEach(window => {
                const lineY = window.y;
                const halfThickness = window.thickness / 2;

                ctx.strokeStyle = '#4682B4';
                ctx.lineWidth = window.thickness;
                ctx.beginPath();
                ctx.moveTo(window.x, lineY);
                ctx.lineTo(window.x + window.width, lineY);
                ctx.stroke();

                ctx.strokeStyle = '#ADD8E6';
                ctx.lineWidth = 1;
                ctx.beginPath();
                ctx.moveTo(window.x, lineY - halfThickness * 0.5);
                ctx.lineTo(window.x + window.width, lineY - halfThickness * 0.5);
                ctx.moveTo(window.x, lineY + halfThickness * 0.5);
                ctx.lineTo(window.x + window.width, lineY + halfThickness * 0.5);
                ctx.stroke();
            });


            // ç»˜åˆ¶å®¶å…·
            roomData.layout.furniture.forEach(item => {
                ctx.strokeStyle = '#333';
                ctx.lineWidth = 1;

                if (item.type === 'bed') {
                    // ç»˜åˆ¶åºŠï¼šçŸ©å½¢ + åºŠå¤´ + æ•å¤´
                    ctx.fillStyle = item.color;
                    ctx.fillRect(item.x, item.y, item.width, item.height);
                    ctx.fillStyle = '#555';
                    ctx.fillRect(item.x, item.y, item.width, 10);
                    ctx.fillStyle = '#FFFFFF'; 
                    ctx.fillRect(item.x + 10, item.y + 15, 40, 25);
                    ctx.fillRect(item.x + item.width - 50, item.y + 15, 40, 25);
                    ctx.strokeStyle = '#FFFFFF';
                    ctx.setLineDash([5, 5]);
                    ctx.beginPath();
                    ctx.rect(item.x, item.y, item.width, item.height);
                    ctx.stroke();
                    ctx.setLineDash([]); 

                } else if (item.type === 'sofa') {
                    // ç»˜åˆ¶æ²™å‘ï¼šä¸»ä½“ + é èƒŒ + æ‰¶æ‰‹
                    const backHeight = 8;
                    const armWidth = 8;
                    ctx.fillStyle = item.color;
                    ctx.fillRect(item.x, item.y, item.width, item.height);
                    ctx.fillStyle = '#555';
                    ctx.fillRect(item.x, item.y, item.width, backHeight);
                    ctx.fillRect(item.x, item.y, armWidth, item.height);
                    ctx.fillRect(item.x + item.width - armWidth, item.y, armWidth, item.height);
                    ctx.strokeStyle = '#FFFFFF';
                    ctx.lineWidth = 1;
                    ctx.beginPath();
                    ctx.moveTo(item.x + item.width / 3, item.y + backHeight);
                    ctx.lineTo(item.x + item.width / 3, item.y + item.height);
                    ctx.moveTo(item.x + item.width * 2 / 3, item.y + backHeight);
                    ctx.lineTo(item.x + item.width * 2 / 3, item.y + item.height);
                    ctx.stroke();

                } else if (item.type === 'table') {
                    // ç»˜åˆ¶èŒ¶å‡ ï¼šçŸ©å½¢ + æ ‡æ³¨çº¿
                    ctx.fillStyle = item.color;
                    ctx.fillRect(item.x, item.y, item.width, item.height);
                    ctx.strokeStyle = '#555';
                    ctx.beginPath();
                    ctx.moveTo(item.x, item.y);
                    ctx.lineTo(item.x + item.width, item.y + item.height);
                    ctx.moveTo(item.x + item.width, item.y);
                    ctx.lineTo(item.x, item.y + item.height);
                    ctx.stroke();

                } else if (item.type === 'toilet') {
                    // ç»˜åˆ¶é©¬æ¡¶ï¼šæ°´ç®±å’Œåº§åœˆ
                    const centerX = item.x + item.width / 2;
                    const centerY = item.y + item.height / 2 + 5;
                    ctx.fillStyle = '#C0C0C0';
                    ctx.fillRect(item.x, item.y, item.width, 10);
                    ctx.strokeStyle = '#555';
                    ctx.lineWidth = 2;
                    ctx.beginPath();
                    ctx.arc(centerX, centerY, 15, Math.PI * 0.25, Math.PI * 1.75);
                    ctx.stroke();

                } else if (item.type === 'sink') {
                    // ç»˜åˆ¶æ´—è„¸å°ï¼šå°é¢ + æ°´æ§½ï¼ˆçŸ©å½¢æ°´æ§½ï¼‰
                    ctx.fillStyle = item.color;
                    ctx.fillRect(item.x, item.y, item.width, item.height);
                    ctx.strokeStyle = '#4682B4';
                    ctx.lineWidth = 2;
                    ctx.strokeRect(item.x + 10, item.y + 10, item.width - 20, item.height - 20);
                    
                } else if (item.type === 'counter' || item.type === 'cabinet' || item.type === 'fridge' || item.type === 'closet') {
                    // æ©±æŸœ/ç”µè§†æŸœ/å†°ç®±/è¡£æŸœï¼šåŒçº¿è¡¨ç¤ºå°é¢/é—¨åšåº¦
                    ctx.fillStyle = item.color;
                    ctx.fillRect(item.x, item.y, item.width, item.height);
                    ctx.strokeStyle = '#333';
                    ctx.lineWidth = 1;
                    ctx.strokeRect(item.x, item.y, item.width, item.height);
                    ctx.strokeStyle = '#777';
                    ctx.lineWidth = 1;
                    ctx.beginPath();
                    ctx.moveTo(item.x + 3, item.y + 3);
                    ctx.lineTo(item.x + item.width - 3, item.y + 3);
                    ctx.moveTo(item.x + 3, item.y + item.height - 3);
                    ctx.lineTo(item.x + item.width - 3, item.y + item.height - 3);
                    ctx.stroke();
                
                } else if (item.type === 'shower') {
                    // ç»˜åˆ¶æ·‹æµ´åŒº (è™šçº¿è¡¨ç¤ºåŒºåŸŸ)
                    ctx.fillStyle = item.color;
                    ctx.fillRect(item.x, item.y, item.width, item.height);
                    ctx.strokeStyle = '#4682B4';
                    ctx.lineWidth = 2;
                    ctx.setLineDash([5, 5]); 
                    ctx.strokeRect(item.x, item.y, item.width, item.height);
                    ctx.setLineDash([]); 
                
                } else {
                    // é»˜è®¤çŸ©å½¢ç»˜åˆ¶
                    ctx.fillStyle = item.color;
                    ctx.fillRect(item.x, item.y, item.width, item.height);
                    ctx.strokeStyle = '#333';
                    ctx.strokeRect(item.x, item.y, item.width, item.height);
                }
                
                drawLabel(item);
            });

            // ç»˜åˆ¶äººç‰©
            ctx.fillStyle = '#FF4500';
            ctx.beginPath();
            ctx.arc(person.x, person.y, person.size / 2, 0, Math.PI * 2);
            ctx.fill();

            ctx.font = `${person.size}px Arial`;
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(person.avatar, person.x, person.y);
        }

        // 3. ç¢°æ’æ£€æµ‹é€»è¾‘ (å·²ä¼˜åŒ–é—¨æ´åˆ¤å®šåŒºåŸŸ)
        function checkCollision(nextX, nextY) {
            const halfSize = person.size / 2;
            const newRect = { x: nextX - halfSize, y: nextY - halfSize, width: person.size, height: person.size };

            // 3.1 å®¶å…·ç¢°æ’
            for (const item of roomData.layout.furniture) {
                const itemRect = { x: item.x, y: item.y, width: item.width, height: item.height };
                if (newRect.x < itemRect.x + itemRect.width && newRect.x + newRect.width > itemRect.x &&
                    newRect.y < itemRect.y + itemRect.height && newRect.y + newRect.height > itemRect.y) {
                    return true;
                }
            }
            
            // 3.2 å¢™å£/é—¨çª—ç¢°æ’ (æ ¸å¿ƒä¼˜åŒ–)
            for (const wall of roomData.layout.walls) {
                let wallRect;
                if (wall.x1 === wall.x2) { 
                    const x = wall.x1 - wall.thickness / 2; const y = Math.min(wall.y1, wall.y2);
                    wallRect = { x: x, y: y, width: wall.thickness, height: Math.abs(wall.y1 - wall.y2) };
                } else { 
                    const y = wall.y1 - wall.thickness / 2; const x = Math.min(wall.x1, wall.x2);
                    wallRect = { x: x, y: y, width: Math.abs(wall.x1 - wall.x2), height: wall.thickness };
                }

                // æ£€æŸ¥äººç‰©æ˜¯å¦ä¸å¢™å£çŸ©å½¢é‡å 
                if (newRect.x < wallRect.x + wallRect.width && newRect.x + newRect.width > wallRect.x &&
                    newRect.y < wallRect.y + wallRect.height && newRect.y + newRect.height > wallRect.y) {
                    
                    let isCollidingWithDoor = false;
                    const DOOR_TOLERANCE = person.size + 2; // å…³é”®ï¼šå°†é—¨æ´çš„åˆ¤å®šåšåº¦æ‰©å¤§åˆ°ç•¥å¤§äºäººç‰©å°ºå¯¸
                    
                    for (const door of roomData.layout.doors) {
                        let doorRect;
                        
                        if (door.direction === 'vertical') {
                            // å‚ç›´é—¨: é—¨æ´çš„ X è½´åšåº¦æ‰©å¤§
                            const doorX = door.x - DOOR_TOLERANCE / 2;
                            doorRect = { x: doorX, y: door.y, width: DOOR_TOLERANCE, height: door.width }; 
                        } else {
                            // æ°´å¹³é—¨: é—¨æ´çš„ Y è½´åšåº¦æ‰©å¤§
                            const doorY = door.y - DOOR_TOLERANCE / 2;
                            doorRect = { x: door.x, y: doorY, width: door.width, height: DOOR_TOLERANCE };
                        }

                        // æ£€æŸ¥äººç‰©æ˜¯å¦ä¸åŠ å®½åçš„é—¨æ´åŒºåŸŸé‡å 
                        if (newRect.x < doorRect.x + doorRect.width && newRect.x + newRect.width > doorRect.x &&
                            newRect.y < doorRect.y + doorRect.height && newRect.y + newRect.height > doorRect.y) {
                            isCollidingWithDoor = true;
                            break;
                        }
                    }
                    
                    if (!isCollidingWithDoor) {
                        return true; // æ’åˆ°å¢™å£äº†ï¼Œä¸”ä¸åœ¨åŠ å®½çš„é—¨æ´åŒºåŸŸå†…ï¼Œå‘ç”Ÿç¢°æ’
                    }
                }
            }
            // é»˜è®¤æ— ç¢°æ’
            return false;
        }


        // 4. æŒç»­ç§»åŠ¨é€»è¾‘ (ä¿æŒä¸å˜)
        const keys = {};
        document.addEventListener('keydown', (e) => { keys[e.key.toUpperCase()] = true; });
        document.addEventListener('keyup', (e) => { keys[e.key.toUpperCase()] = false; });

        function gameLoop() {
            let nextX = person.x;
            let nextY = person.y;
            let moved = false;

            if (keys['W']) { nextY -= MOVE_SPEED; moved = true; }
            if (keys['S']) { nextY += MOVE_SPEED; moved = true; }
            if (keys['A']) { nextX -= MOVE_SPEED; moved = true; }
            if (keys['D']) { nextX += MOVE_SPEED; moved = true; }

            if (moved) {
                const targetX = nextX;
                const targetY = nextY;
                let finalX = person.x;
                let finalY = person.y;

                // å°è¯•ç‹¬ç«‹ç§»åŠ¨ X è½´å’Œ Y è½´ï¼Œå¤„ç†æ–œå‘ç¢°æ’
                if (!checkCollision(targetX, person.y)) { finalX = targetX; }
                if (!checkCollision(person.x, targetY)) { finalY = targetY; }

                if (finalX !== person.x || finalY !== person.y) {
                    person.x = finalX;
                    person.y = finalY;
                    drawRoom();
                }
            }
            // å¾ªç¯è°ƒç”¨ä¸‹ä¸€å¸§
            requestAnimationFrame(gameLoop);
        }

        // å¯åŠ¨
        drawRoom();
        requestAnimationFrame(gameLoop);
    </script>

</body>
</html>